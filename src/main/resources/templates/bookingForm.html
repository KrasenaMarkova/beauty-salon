<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Запазване на час</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<form id="booking-form" th:action="@{/booking/save}" th:object="${bookingForm}" method="post">

  <input type="hidden" th:field="*{date}" id="hiddenDate">
  <input type="hidden" th:field="*{selectedTime}" id="hiddenTime">
  <input type="hidden" th:field="*{serviceId}" id="hiddenServiceId">

<!--  <input type="hidden" th:field="*{userId}" th:value="${#authentication != null ? #authentication.principal.user.id : 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'}">-->
  <input type="hidden" th:field="*{userId}" value="a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11">

  <label for="serviceId">Услуга:</label>
  <select id="serviceId" name="serviceId" required> <option value="">Изберете...</option>
    <option th:each="treatment : ${treatments}"
            th:value="${treatment.id}"
            th:text="${treatment.serviceName.displayName + ' (' + treatment.durationMinutes + ' мин.)'}">
    </option>
  </select>

  <label for="bookingDate">Дата:</label>
  <input type="date" id="bookingDate" name="date" required>
  <br>

  <label>Свободни часове:</label>
  <div id="time-slots-container">
  </div>

  <br>

  <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>


  <button type="submit">Резервирай</button>
</form>

<script>
  // AJAX логика, която не само зарежда, но и синхронизира стойностите с формата:
  $('#bookingDate, #serviceId').on('change', function() {
    var date = $('#bookingDate').val();
    var serviceId = $('#serviceId').val();
    var slotsContainer = $('#time-slots-container');

    // КОРЕКЦИЯ: Синхронизиране на скритите полета
    $('#hiddenDate').val(date);
    $('#hiddenServiceId').val(serviceId);
    $('#hiddenTime').val('');

    if (date && serviceId) {
      slotsContainer.html('<p>Зареждане на часове...</p>'); // Временно съобщение

      $.ajax({
        url: '/available-slots',
        type: 'GET',
        data: {
          date: date,
          serviceId: serviceId
        },
        success: function(slots) {
          slotsContainer.empty(); // Изчистване на предишното съдържание

          if (slots.length > 0) {
            slots.forEach(function(slot) {
              // ГЕНЕРИРАНЕ НА РАДИО БУТОНИТЕ
              var radio = `
                            <input type="radio" name="selectedTime" value="${slot}" id="slot-${slot}" required>
                            <label for="slot-${slot}">${slot}</label>&nbsp;&nbsp;
                        `;
              slotsContainer.append(radio);
            });
          } else {
            slotsContainer.append('<p class="text-danger">Няма свободни часове за тази комбинация.</p>');
          }
        },
        error: function(xhr, status, error) {
          slotsContainer.empty();
          slotsContainer.append('<p class="text-danger">Грешка при зареждане на часовете. Проверете дали има услуга и служител в базата.</p>');
          console.error("AJAX Error: ", status, error);
        }
      });
    } else {
      slotsContainer.empty();
    }
  });

  // Този слушател е правилен и трябва да остане
  $(document).on('change', 'input[name="selectedTime"]', function() {
    $('#hiddenTime').val($(this).val());
  });
</script>

</body>
</html>